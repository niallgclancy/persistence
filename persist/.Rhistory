# 2. Build your community matrix and distance matrix
# (Assuming wc.mat or comm is your sites × species presence/absence matrix)
dist_jac <- vegdist(wc.mat, method = "jaccard", binary = TRUE)
# 3. Combine metadata (must match row order of wc.mat)
env <- sc[, c("RepeatID", "PU", "TIME", "temp_cat")]
# 4. PERMDISP setup
# Test whether within-basin dispersions differ between TIME periods
# (First, group by PU × TIME)
group <- interaction(env$PU, env$temp_cat,env$TIME)
disp <- betadisper(dist_jac, group = group)
# 5. Test for differences in dispersion between time periods within each basin
anova(disp)              # overall test, p-value <0.01
perm_res=permutest(disp, pairwise = TRUE)  # permutation test (pairwise comparisons)
perm_res$pairwise$permuted
# 6. Extract mean distances to centroid for plotting
centroid_df <- as.data.frame(disp$group)
centroid_df$distance <- disp$distances
centroid_df <- cbind(centroid_df, env)
homog.test=aggregate(distance ~ PU + temp_cat+TIME, data = centroid_df, FUN = mean)
homog.test=homog.test%>%pivot_wider(names_from = "TIME", values_from = "distance")
homog.test$change=NA
homog.test$change=homog.test$LATE-homog.test$EARLY
homog.test%>%
ggplot(aes(x=temp_cat, y=change, shape = PU, color=temp_cat))+
scale_shape_manual(values = 15:18)+
scale_color_manual(values = c("steelblue", "tomato"))+
geom_point(size=4)+
theme_classic()
#------Trajectories by Basin---------
# Ensure TIME and PU are proper factors
sc$TIME <- factor(sc$TIME, levels = c("EARLY", "LATE"))
sc$PU <- factor(sc$PU)
unique(sc$PU)
sc$temp_cat <- NA
sc$temp_cat[sc$temp >= 20] <- "WARM"
sc$temp_cat[sc$temp <  20] <- "COOL"
sc$temp_cat <- factor(sc$temp_cat, levels = c("COOL","WARM"))  # nice legend order
# Colors for basins
basin_cols <- setNames(c("limegreen","firebrick3","dodgerblue2","goldenrod1"), levels(sc$PU))
# Base empty plot (no points)
plot(sc$NMDS1, sc$NMDS2, type = "n", xlab = "NMDS1", ylab = "NMDS2")
# Arrows per site, colored by temp category at that site; ensure EARLY -> LATE
by(sc, sc$RepeatID, function(df) {
if (nrow(df) == 2) {
df <- df[order(df$TIME), ]  # EARLY (row 1) -> LATE (row 2)
col_here <- basin_cols[as.character(df$PU[1])]  # same site temp_cat
arrows(df$NMDS1[1], df$NMDS2[1],
df$NMDS1[2], df$NMDS2[2],
length = 0.06, angle = 20, lwd = 2,
col = col_here)
}
})
# Legend for temperature categories
legend("bottomleft", lwd = 2, col = basin_cols,
legend = names(basin_cols), title = "Basin", bty = "n")
title("Community Trajectories by Basin")
pl2=recordPlot()
pl2
# Make sure TIME is ordered
sc$TIME <- factor(sc$TIME, levels = c("EARLY", "LATE"))
# Calculate arrow lengths (distance between EARLY and LATE)
arrow_lengths <- sc %>%
arrange(RepeatID, TIME) %>%
group_by(RepeatID) %>%
filter(n() == 2) %>%                    # only include sites with both samples
summarize(
PU        = first(PU),
temp_cat  = first(temp_cat),
length    = sqrt((NMDS1[2] - NMDS1[1])^2 + (NMDS2[2] - NMDS2[1])^2)
)
# Inspect results
head(arrow_lengths)
# Average arrow length by temperature category
arrows=arrow_lengths %>%
group_by(PU) %>%
summarize(
mean_length = mean(length, na.rm = TRUE),
sd_length   = sd(length, na.rm = TRUE),
se_length = sd(length)/sqrt(length(length)),
n           = n()
)
arrows
arrows$PU=as.character(arrows$PU)
arrows$PU[which(arrows$PU=="CHEY")]="Cheyenne-Little Mo"
arrows$PU[which(arrows$PU=="PLAT")]="Platte"
arrows$PU[which(arrows$PU=="UPMO")]="Upper Missouri"
arrows$PU[which(arrows$PU=="YELL")]="Yellowstone"
arrows$PU=as.factor(arrows$PU)
meanarrowPU=
arrows%>%
ggplot(aes(x=PU, y= mean_length))+
ylab("NMDS Vector Length")+
xlab("Major Basin")+
ylim(0,1)+
ggtitle("Community Change by Basin")+
geom_pointrange(ymin=arrows$mean_length-arrows$se_length,
ymax=arrows$mean_length+arrows$se_length,
linewidth=1.5, size=1)+
theme_classic()+
theme(axis.title = element_text(size=16),
axis.text = element_text(size=14, color = "black"),
plot.title = element_text(size=16, color = "black"),
legend.position = "none")
meanarrowPU
ggarrange(pl,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 12, height = 8, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 10, height = 8, units = "in", dpi = 400)
ggarrange(pl,meanarrow, meanarrowPU,ncol=1)
ggarrange(pl,meanarrow, meanarrowPU,ncol=3)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 10, height = 8, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 10, height = 5, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 12, height = 5, units = "in", dpi = 400)
ggarrange(pl,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
title("Community Trajectories by Stream Temperature", face=1)
# Calculate arrow lengths (distance between EARLY and LATE)
arrow_lengths <- sc %>%
arrange(RepeatID, TIME) %>%
group_by(RepeatID) %>%
filter(n() == 2) %>%                    # only include sites with both samples
summarize(
PU        = first(PU),
temp_cat  = first(temp_cat),
length    = sqrt((NMDS1[2] - NMDS1[1])^2 + (NMDS2[2] - NMDS2[1])^2)
)
# Inspect results
head(arrow_lengths)
# Average arrow length by temperature category
arrows=arrow_lengths %>%
group_by(temp_cat) %>%
summarize(
mean_length = mean(length, na.rm = TRUE),
sd_length   = sd(length, na.rm = TRUE),
se_length = sd(length)/sqrt(length(length)),
n           = n()
)
arrows
meanarrow=
arrows%>%
ggplot(aes(x=temp_cat, y= mean_length, color=temp_cat))+
scale_color_manual(values = c("steelblue", "tomato"))+
ylim(limits=c(0.2,0.8))+
ylab("NMDS Vector Length")+
xlab("Stream Temperature")+
ggtitle("Community Change by Temperature")+
geom_pointrange(ymin=arrows$mean_length-arrows$se_length,
ymax=arrows$mean_length+arrows$se_length,
linewidth=1.5, size=1)+
theme_classic()+
theme(axis.title = element_text(size=12, face = "bold"),
axis.text = element_text(size=12, color = "black"),
plot.title = element_text(size=14, color = "black"),
legend.position = "none")
meanarrow
#BIOTIC HOMOGENIZATION TEST WITH TEMPERATURE
sc$PU   <- factor(sc$PU)
sc$temp_cat = factor(sc$temp_cat)
#------Trajectories by Basin---------
# Ensure TIME and PU are proper factors
sc$TIME <- factor(sc$TIME, levels = c("EARLY", "LATE"))
sc$PU <- factor(sc$PU)
unique(sc$PU)
sc$temp_cat <- NA
sc$temp_cat[sc$temp >= 20] <- "WARM"
sc$temp_cat[sc$temp <  20] <- "COOL"
sc$temp_cat <- factor(sc$temp_cat, levels = c("COOL","WARM"))  # nice legend order
# Colors for basins
basin_cols <- setNames(c("limegreen","firebrick3","dodgerblue2","goldenrod1"), levels(sc$PU))
# Base empty plot (no points)
plot(sc$NMDS1, sc$NMDS2, type = "n", xlab = "NMDS1", ylab = "NMDS2")
# Arrows per site, colored by temp category at that site; ensure EARLY -> LATE
by(sc, sc$RepeatID, function(df) {
if (nrow(df) == 2) {
df <- df[order(df$TIME), ]  # EARLY (row 1) -> LATE (row 2)
col_here <- basin_cols[as.character(df$PU[1])]  # same site temp_cat
arrows(df$NMDS1[1], df$NMDS2[1],
df$NMDS1[2], df$NMDS2[2],
length = 0.06, angle = 20, lwd = 2,
col = col_here)
}
})
# Legend for temperature categories
legend("bottomleft", lwd = 2, col = basin_cols,
legend = names(basin_cols), title = "Basin", bty = "n")
title("Community Trajectories by Basin")
pl2=recordPlot()
pl2
# Make sure TIME is ordered
sc$TIME <- factor(sc$TIME, levels = c("EARLY", "LATE"))
# Calculate arrow lengths (distance between EARLY and LATE)
arrow_lengths <- sc %>%
arrange(RepeatID, TIME) %>%
group_by(RepeatID) %>%
filter(n() == 2) %>%                    # only include sites with both samples
summarize(
PU        = first(PU),
temp_cat  = first(temp_cat),
length    = sqrt((NMDS1[2] - NMDS1[1])^2 + (NMDS2[2] - NMDS2[1])^2)
)
# Inspect results
head(arrow_lengths)
# Average arrow length by temperature category
arrows=arrow_lengths %>%
group_by(PU) %>%
summarize(
mean_length = mean(length, na.rm = TRUE),
sd_length   = sd(length, na.rm = TRUE),
se_length = sd(length)/sqrt(length(length)),
n           = n()
)
arrows
arrows$PU=as.character(arrows$PU)
arrows$PU[which(arrows$PU=="CHEY")]="Cheyenne-Little Mo"
arrows$PU[which(arrows$PU=="PLAT")]="Platte"
arrows$PU[which(arrows$PU=="UPMO")]="Upper Missouri"
arrows$PU[which(arrows$PU=="YELL")]="Yellowstone"
arrows$PU=as.factor(arrows$PU)
meanarrowPU=
arrows%>%
ggplot(aes(x=PU, y= mean_length))+
ylab("NMDS Vector Length")+
xlab("Major Basin")+
ylim(0,1)+
ggtitle("Community Change by Basin")+
geom_pointrange(ymin=arrows$mean_length-arrows$se_length,
ymax=arrows$mean_length+arrows$se_length,
linewidth=1.5, size=1)+
theme_classic()+
theme(axis.title = element_text(size=16),
axis.text = element_text(size=14, color = "black"),
plot.title = element_text(size=16, color = "black"),
legend.position = "none")
meanarrowPU
meanarrowPU=
arrows%>%
ggplot(aes(x=PU, y= mean_length))+
ylab("NMDS Vector Length")+
xlab("Major Basin")+
ylim(0,1)+
ggtitle("Community Change by Basin")+
geom_pointrange(ymin=arrows$mean_length-arrows$se_length,
ymax=arrows$mean_length+arrows$se_length,
linewidth=1.5, size=1)+
theme_classic()+
theme(axis.title = element_text(size=12, face = "bold"),
axis.text = element_text(size=12, color = "black"),
plot.title = element_text(size=14, color = "black"),
legend.position = "none")
meanarrowPU
ggarrange(pl,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 12, height = 5, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 12, height = 10, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 12, height = 12, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 6, height = 6, units = "in", dpi = 400)
# Arrows per site, colored by temp category at that site; ensure EARLY -> LATE
by(sc, sc$RepeatID, function(df) {
if (nrow(df) == 2) {
df <- df[order(df$TIME), ]  # EARLY (row 1) -> LATE (row 2)
col_here <- temp_cols[as.character(df$temp_cat[1])]  # same site temp_cat
arrows(df$NMDS1[1], df$NMDS2[1],
df$NMDS1[2], df$NMDS2[2],
length = 0.06, angle = 20, lwd = 2,
col = col_here)
}
})
# Legend for temperature categories
legend("bottomleft", lwd = 2, col = temp_cols,
legend = names(temp_cols), title = "Temperature", bty = "n")
title("Community Trajectories by Stream Temperature")
pl=recordPlot()
pl
sc <- as.data.frame(scores(nmds, display = "sites"))
sc=cbind(sc, wc.meta)
sc$NMDS1=as.numeric(sc$NMDS1)
sc$NMDS2=as.numeric(sc$NMDS2)
# Ensure TIME and PU are proper factors
sc$TIME <- factor(sc$TIME, levels = c("EARLY", "LATE"))
sc$temp_cat <- NA
sc$temp_cat[sc$temp >= 20] <- "WARM"
sc$temp_cat[sc$temp <  20] <- "COOL"
sc$temp_cat <- factor(sc$temp_cat, levels = c("COOL","WARM"))  # nice legend order
# Colors for temperature categories
temp_cols <- setNames(c("steelblue", "tomato"), levels(sc$temp_cat))
# Base empty plot (no points)
plot(sc$NMDS1, sc$NMDS2, type = "n", xlab = "NMDS1", ylab = "NMDS2")
# Arrows per site, colored by temp category at that site; ensure EARLY -> LATE
by(sc, sc$RepeatID, function(df) {
if (nrow(df) == 2) {
df <- df[order(df$TIME), ]  # EARLY (row 1) -> LATE (row 2)
col_here <- temp_cols[as.character(df$temp_cat[1])]  # same site temp_cat
arrows(df$NMDS1[1], df$NMDS2[1],
df$NMDS1[2], df$NMDS2[2],
length = 0.06, angle = 20, lwd = 2,
col = col_here)
}
})
# Legend for temperature categories
legend("bottomleft", lwd = 2, col = temp_cols,
legend = names(temp_cols), title = "Temperature", bty = "n")
title("Community Trajectories by Stream Temperature")
pl=recordPlot()
library(grid)   # for unit()
# Make a data frame of EARLY -> LATE arrows for each RepeatID
arrows_df <- sc %>%
group_by(RepeatID) %>%
filter(n() == 2) %>%        # keep only pairs
arrange(TIME) %>%           # EARLY then LATE (given factor levels)
summarise(
NMDS1_start = first(NMDS1),
NMDS2_start = first(NMDS2),
NMDS1_end   = last(NMDS1),
NMDS2_end   = last(NMDS2),
temp_cat    = first(temp_cat),
.groups = "drop"
)
# Recreate your color mapping (or reuse existing temp_cols)
temp_cols <- setNames(c("steelblue", "tomato"),
c("COOL", "WARM"))
# ggplot version of the NMDS arrows
ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()
# ggplot version of the NMDS arrows
ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()++
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_rect(fill = "white", color = "gray80"),
legend.title = element_text(size = 9),
legend.text  = element_text(size = 8)
)
# ggplot version of the NMDS arrows
ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_rect(fill = "white", color = "gray80"),
legend.title = element_text(size = 9),
legend.text  = element_text(size = 8)
)
# ggplot version of the NMDS arrows
ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_rect(fill = "white", color = "gray80"),
legend.title = element_text(size = 9),
legend.text  = element_text(size = 8)
)
# ggplot version of the NMDS arrows
plarrow=ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_rect(fill = "white", color = "gray80"),
legend.title = element_text(size = 9),
legend.text  = element_text(size = 8)
)
ggarrange(plarrow,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggarrange(plarrow,
ggarrange(meanarrow, meanarrowPU, ncol = 2))
ggarrange(plarrow,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 6, height = 6, units = "in", dpi = 400)
# ggplot version of the NMDS arrows
plarrow=ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15)
)
plarrow
# ggplot version of the NMDS arrows
plarrow=ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_rect(fill = "white", color = "gray80")
)
plarrow
ggarrange(plarrow,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggsave(filename = "ORDINATIONrestuls.tiff", width = 10, height = 10, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.jpeg", width = 10, height = 10, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.jpeg", width = 12, height = 10, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.jpeg", width = 8, height = 6, units = "in", dpi = 400)
# ggplot version of the NMDS arrows
plarrow=ggplot(arrows_df) +
geom_segment(
aes(x = NMDS1_start, y = NMDS2_start,
xend = NMDS1_end, yend = NMDS2_end,
colour = temp_cat),
arrow     = arrow(length = unit(0.2, "cm"), angle = 20),
linewidth = 0.8
) +
scale_colour_manual(values = temp_cols, name = "Temperature") +
labs(
x = "NMDS1",
y = "NMDS2",
title = "Community Trajectories by Stream Temperature"
) +
coord_equal() +
theme_bw()+
theme(
legend.position = c(0.15, 0.15),   # (x, y) in relative plot coordinates
legend.background = element_blank(),
legend.title = element_blank()
)
plarrow
ggarrange(plarrow,
ggarrange(meanarrow, meanarrowPU, ncol = 2), ncol=1)
ggsave(filename = "ORDINATIONrestuls.jpeg", width = 8, height = 6, units = "in", dpi = 400)
ggsave(filename = "ORDINATIONrestuls.jpeg", width = 12, height = 10, units = "in", dpi = 400)
