coeff <- coeff %>%
arrange(Score2) %>%
mutate(Var2 = factor(Var2, levels = Var2))
p <- ggplot(coeff, aes(x = Var2, y = Score2, colour = Sign)) +
geom_segment(aes(xend = Var2, y = 0, yend = Score2)) +
geom_point(size = 4) +
theme_light() +
scale_color_manual(values = c("#ff9999", "#018080")) +
theme(
panel.grid.major.x = element_blank(),
panel.border = element_blank(),
axis.ticks.x = element_blank(),
legend.position = "none"
) +
ggtitle(label = paste(i, "- Variable Importance")) +
xlab("") +
coord_flip() +
ylab("Absolute Coefficient")
print(p)
# Optional: save plot
# ggsave(filename = paste0("varimp_", i, ".png"), plot = p, width = 6, height = 4)
}
keep <- complete.cases(NETcol3[, c(i, predictors)])
i.sub <- NETcol[keep, , drop = FALSE]
View(nogreen)
#####INDIVIDUAL SPECIES COLONIZATION-PERSISTENCE MODELS
NETcol=NET
NETcol$change[which(NETcol$change==0)]=1
NETcol$change[which(NETcol$change==-1)]=0
prosperNETprosperdat=nogreen[,c(19,141)]
prosperdat=prosperdat%>%rename("RepeatID"="RepetID")
prosperdat=nogreen[,c(19,141)]
prosperdat=prosperdat%>%rename("RepeatID"="RepetID")
NETcol=left_join(NETcol, prosperdat, by="RepeatID")
NETcol2=NETcol%>%group_by(Species)%>%summarise(n=length(CommonName))
NETcol30=subset(NETcol2,NETcol2$n>=30)
#####INDIVIDUAL SPECIES COLONIZATION-PERSISTENCE MODELS
NETcol=NET
NETcol$change[which(NETcol$change==0)]=1
NETcol$change[which(NETcol$change==-1)]=0
prosperdat=nogreen[,c(19,141)]
prosperdat=prosperdat%>%rename("RepeatID"="RepetID")
NETcol=left_join(NETcol, prosperdat, by="RepeatID")
View(NETcol)
NETcol2=NETcol%>%group_by(Species)%>%summarise(n=length(CommonName))
NETcol30=subset(NETcol2,NETcol2$n>=30)
View(NETcol30)
NETcol30sp=NETcol30$Species
NETcol=subset(NETcol,NETcol$Species%in%NETcol30sp)
NETcol=NETcol%>%rename("temp"="S1_93_11","barrier"="DSbarrier",
"length"="Length_km", "size"="F_MAUG_HIS",
"pisc"="nnPreds")
NETcol3=NETcol[,c(2,3,15,18,19,22,24,25,26,33,36,37,55)]
NETcol3=NETcol3%>%pivot_wider(names_from = "Species", values_from = "change")
View(NETcol3)
#####-----INDIVIDUAL SPECIES COLONIZATION MODELS-----
library(dplyr)
library(ggplot2)
species_cols <- NETcol30sp
predictors_all <- c("temp", "barrier", "length", "size","prosper", "pisc")
# species that should NOT include "pisc"
no_pisc_species <- c("LL", "GSUN", "SMB", "NP")
models <- setNames(vector("list", length(species_cols)), species_cols)
for (i in species_cols) {
cat("\n--------------------------------------------\n")
cat("Fitting:", i, "\n")
# Choose predictors
predictors <- if (i %in% no_pisc_species) {
setdiff(predictors_all, "pisc")
} else {
predictors_all
}
# Keep rows with no NAs in the response or predictors
keep <- complete.cases(NETcol3[, c(i, predictors)])
i.sub <- NETcol[keep, , drop = FALSE]
# Build formula and fit model
terms_scaled <- paste0("scale(", predictors, ")")
fml <- reformulate(terms_scaled, response = i)
i.model <- glm(fml, family = binomial, data = i.sub)
models[[i]] <- i.model
# Print model summary
print(summary(i.model))
# --- Variable importance plot ---
coeff <- as.data.frame(i.model$coefficients)
coeff$Variable <- rownames(coeff)
names(coeff)[1] <- "Score"
coeff <- coeff[-1, , drop = FALSE]  # remove intercept
coeff$Score2 <- abs(coeff$Score)
coeff$Sign <- ifelse(coeff$Score > 0, "Pos", "Neg")
coeff$Var2 <- NA
coeff$Var2[coeff$Variable == "scale(temp)"]    <- "Temperature"
coeff$Var2[coeff$Variable == "scale(barrier)"] <- "Barriers"
coeff$Var2[coeff$Variable == "scale(length)"]  <- "Fragment Length"
coeff$Var2[coeff$Variable == "scale(prosper)"] <- "Flow Permanence"
coeff$Var2[coeff$Variable == "scale(pisc)"]    <- "Piscivores"
coeff$Var2[coeff$Variable == "scale(size)"] <- "Stream Size"
coeff <- coeff %>%
arrange(Score2) %>%
mutate(Var2 = factor(Var2, levels = Var2))
p <- ggplot(coeff, aes(x = Var2, y = Score2, colour = Sign)) +
geom_segment(aes(xend = Var2, y = 0, yend = Score2)) +
geom_point(size = 4) +
theme_light() +
scale_color_manual(values = c("#ff9999", "#018080")) +
theme(
panel.grid.major.x = element_blank(),
panel.border = element_blank(),
axis.ticks.x = element_blank(),
legend.position = "none"
) +
ggtitle(label = paste(i, "- Variable Importance")) +
xlab("") +
coord_flip() +
ylab("Absolute Coefficient")
print(p)
# Optional: save plot
# ggsave(filename = paste0("varimp_", i, ".png"), plot = p, width = 6, height = 4)
}
write.csv(NETcol3,"NETcol3.csv")
library(dplyr)
library(ggplot2)
NETcol3 <- read.csv("NETcol3.csv")  # if not already loaded
NETcol=NET
NETcol$change[which(NETcol$change==0)]=1
NETcol$change[which(NETcol$change==-1)]=0
prosperdat=nogreen[,c(19,141)]
prosperdat=prosperdat%>%rename("RepeatID"="RepetID")
NETcol=left_join(NETcol, prosperdat, by="RepeatID")
NETcol2=NETcol%>%group_by(Species)%>%summarise(n=length(CommonName))
NETcol30=subset(NETcol2,NETcol2$n>=30)
NETcol30sp=NETcol30$Species
NETcol=subset(NETcol,NETcol$Species%in%NETcol30sp)
NETcol=NETcol%>%rename("temp"="S1_93_11","barrier"="DSbarrier",
"length"="Length_km", "size"="F_MAUG_HIS",
"pisc"="nnPreds")
NETcol3=NETcol[,c(2,3,15,18,19,22,24,25,26,33,36,37,55)]
NETcol3=NETcol3%>%pivot_wider(names_from = "Species", values_from = "change")
# species column names (make sure this is a character vector of names)
species_cols <- NETcol30sp          # e.g. names(NETcol3)[13:32]
predictors_all <- c("temp", "barrier", "length", "size", "prosper", "pisc")
# species that should NOT include "pisc"
no_pisc_species <- c("LL", "GSUN", "SMB", "NP")
models <- setNames(vector("list", length(species_cols)), species_cols)
for (i in species_cols) {
# species column names (make sure this is a character vector of names)
species_cols <- NETcol30sp          # e.g. names(NETcol3)[13:32]
predictors_all <- c("temp", "barrier", "length", "size", "prosper", "pisc")
# species that should NOT include "pisc"
no_pisc_species <- c("LL", "GSUN", "SMB", "NP")
models <- setNames(vector("list", length(species_cols)), species_cols)
for (i in species_cols) {
cat("Fitting:", i, "\n")
# Choose predictors
predictors <- if (i %in% no_pisc_species) {
setdiff(predictors_all, "pisc")
} else {
predictors_all
}
# Keep rows with no NAs in the response or predictors
keep  <- complete.cases(NETcol3[, c(i, predictors)])
i.sub <- NETcol3[keep, , drop = FALSE]
# Build formula and fit model
terms_scaled <- paste0("scale(", predictors, ")")
fml <- reformulate(terms_scaled, response = i)
i.model <- glm(fml, family = binomial, data = i.sub)
models[[i]] <- i.model
# Print model summary
print(summary(i.model))
# --- Variable importance plot ---
coeff <- as.data.frame(i.model$coefficients)
coeff$Variable <- rownames(coeff)
names(coeff)[1] <- "Score"
coeff <- coeff[-1, , drop = FALSE]  # remove intercept
coeff$Score2 <- abs(coeff$Score)
coeff$Sign <- ifelse(coeff$Score > 0, "Pos", "Neg")
coeff$Var2 <- NA
coeff$Var2[coeff$Variable == "scale(temp)"]    <- "Temperature"
coeff$Var2[coeff$Variable == "scale(barrier)"] <- "Barriers"
coeff$Var2[coeff$Variable == "scale(length)"]  <- "Fragment Length"
coeff$Var2[coeff$Variable == "scale(prosper)"] <- "Flow Permanence"
coeff$Var2[coeff$Variable == "scale(pisc)"]    <- "Piscivores"
coeff$Var2[coeff$Variable == "scale(size)"]    <- "Stream Size"
coeff <- coeff %>%
ar
# species column names (make sure this is a character vector of names)
species_cols <- NETcol30sp          # e.g. names(NETcol3)[13:32]
predictors_all <- c("temp", "barrier", "length", "size", "prosper", "pisc")
# species that should NOT include "pisc"
no_pisc_species <- c("LL", "GSUN", "SMB", "NP")
models <- setNames(vector("list", length(species_cols)), species_cols)
for (i in species_cols) {
cat("\n--------------------------------------------\n")
cat("Fitting:", i, "\n")
# Choose predictors
predictors <- if (i %in% no_pisc_species) {
setdiff(predictors_all, "pisc")
} else {
predictors_all
}
# Keep rows with no NAs in the response or predictors
keep  <- complete.cases(NETcol3[, c(i, predictors)])
i.sub <- NETcol3[keep, , drop = FALSE]
# Build formula and fit model
terms_scaled <- paste0("scale(", predictors, ")")
fml <- reformulate(terms_scaled, response = i)
i.model <- glm(fml, family = binomial, data = i.sub)
models[[i]] <- i.model
# Print model summary
print(summary(i.model))
# --- Variable importance plot ---
coeff <- as.data.frame(i.model$coefficients)
coeff$Variable <- rownames(coeff)
names(coeff)[1] <- "Score"
coeff <- coeff[-1, , drop = FALSE]  # remove intercept
coeff$Score2 <- abs(coeff$Score)
coeff$Sign <- ifelse(coeff$Score > 0, "Pos", "Neg")
coeff$Var2 <- NA
coeff$Var2[coeff$Variable == "scale(temp)"]    <- "Temperature"
coeff$Var2[coeff$Variable == "scale(barrier)"] <- "Barriers"
coeff$Var2[coeff$Variable == "scale(length)"]  <- "Fragment Length"
coeff$Var2[coeff$Variable == "scale(prosper)"] <- "Flow Permanence"
coeff$Var2[coeff$Variable == "scale(pisc)"]    <- "Piscivores"
coeff$Var2[coeff$Variable == "scale(size)"]    <- "Stream Size"
coeff <- coeff %>%
arrange(Score2) %>%
mutate(Var2 = factor(Var2, levels = Var2))
p <- ggplot(coeff, aes(x = Var2, y = Score2, colour = Sign)) +
geom_segment(aes(xend = Var2, y = 0, yend = Score2)) +
geom_point(size = 4) +
theme_light() +
scale_color_manual(values = c("#ff9999", "#018080")) +
theme(
panel.grid.major.x = element_blank(),
panel.border = element_blank(),
axis.ticks.x = element_blank(),
legend.position = "none"
) +
ggtitle(label = paste(i, "- Variable Importance")) +
xlab("") +
coord_flip() +
ylab("Absolute Coefficient")
print(p)
}
predictors_all <- c("temp", "barrier", "length", "prosper", "size","pisc")
asdfasdfasd
asdfqwerqwee23
33321f
# species column names (make sure this is a character vector of names)
species_cols <- NETcol30sp          # e.g. names(NETcol3)[13:32]
predictors_all <- c("temp", "barrier", "length", "size", "prosper", "pisc")
# species that should NOT include "pisc"
no_pisc_species <- c("LL", "GSUN", "SMB", "NP")
models <- setNames(vector("list", length(species_cols)), species_cols)
for (i in species_cols) {
cat("\n--------------------------------------------\n")
cat("Fitting:", i, "\n")
# Choose predictors
predictors <- if (i %in% no_pisc_species) {
setdiff(predictors_all, "pisc")
} else {
predictors_all
}
# Keep rows with no NAs in the response or predictors
keep  <- complete.cases(NETcol3[, c(i, predictors)])
i.sub <- NETcol3[keep, , drop = FALSE]
# Build formula and fit model
terms_scaled <- paste0("scale(", predictors, ")")
fml <- reformulate(terms_scaled, response = i)
i.model <- glm(fml, family = binomial, data = i.sub)
models[[i]] <- i.model
# Print model summary
print(summary(i.model))
# --- Variable importance plot ---
coeff <- as.data.frame(i.model$coefficients)
coeff$Variable <- rownames(coeff)
names(coeff)[1] <- "Score"
coeff <- coeff[-1, , drop = FALSE]  # remove intercept
coeff$Score2 <- abs(coeff$Score)
coeff$Sign <- ifelse(coeff$Score > 0, "Pos", "Neg")
coeff$Var2 <- NA
coeff$Var2[coeff$Variable == "scale(temp)"]    <- "Temperature"
coeff$Var2[coeff$Variable == "scale(barrier)"] <- "Barriers"
coeff$Var2[coeff$Variable == "scale(length)"]  <- "Fragment Length"
coeff$Var2[coeff$Variable == "scale(prosper)"] <- "Flow Permanence"
coeff$Var2[coeff$Variable == "scale(pisc)"]    <- "Piscivores"
coeff$Var2[coeff$Variable == "scale(size)"]    <- "Stream Size"
coeff <- coeff %>%
arrange(Score2) %>%
mutate(Var2 = factor(Var2, levels = Var2))
p <- ggplot(coeff, aes(x = Var2, y = Score2, colour = Sign)) +
geom_segment(aes(xend = Var2, y = 0, yend = Score2)) +
geom_point(size = 4) +
theme_light() +
scale_color_manual(values = c("#ff9999", "#018080")) +
theme(
panel.grid.major.x = element_blank(),
panel.border = element_blank(),
axis.ticks.x = element_blank(),
legend.position = "none"
) +
ggtitle(label = paste(i, "- Variable Importance")) +
xlab("") +
coord_flip() +
ylab("Absolute Coefficient")
print(p)
}
predictors_all <- c("temp", "barrier", "length", "prosper", "size","pisc")
term_name <- function(var) paste0("scale(", var, ")")
# choose scaling method: "sum" or "max"
scale_method <- "sum"  # or "max"
make_species_row <- function(sp, fit) {
sm <- summary(fit)
coefs <- sm$coefficients
# Pull coefficients and p-values for our predictors
est <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Estimate"] else NA_real_
})
pvals <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Pr(>|z|)"] else NA_real_
})
# Scale coefficients by sum or max of absolute values
denom <- if (scale_method == "sum") sum(abs(est), na.rm = TRUE) else max(abs(est), na.rm = TRUE)
if (is.finite(denom) && denom != 0) {
scaled_est <- est / denom
} else {
scaled_est <- est
}
# Format with asterisk for p < 0.1 (but keep sign)
fmt <- function(val, p) {
if (is.na(val)) return(NA_character_)
paste0(format(round(val, 3), nsmall = 3),
ifelse(!is.na(p) && p < 0.1, "*", ""))
}
cells <- mapply(fmt, scaled_est, pvals, USE.NAMES = FALSE)
names(cells) <- predictors_all
# AIC
aic_val <- AIC(fit)
# Return one row
data.frame(
species = sp,
as.list(cells),
AIC = round(aic_val, 2),
check.names = FALSE
)
}
# Build the full table
species_vec <- names(models)
rows <- lapply(species_vec, function(sp) make_species_row(sp, models[[sp]]))
varimp_table_signed <- do.call(rbind, rows)
varimp_table_signed <- varimp_table_signed[, c("species", predictors_all, "AIC")]
# Preview
print(varimp_table_signed)
write.csv(varimp_table_signed, "species_var_importance_COLandPERS.csv", row.names = FALSE)
######Ranked Variable Importance
make_species_row <- function(sp, fit) {
sm <- summary(fit)
coefs <- sm$coefficients
# Pull coefficients and p-values for our predictors
est <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Estimate"] else NA_real_
})
pvals <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Pr(>|z|)"] else NA_real_
})
# ---- Convert coefficients to absolute-value ranks ----
# Larger absolute effect = lower rank number
abs_est <- abs(est)
# Rank only non-NA values
ranked <- rep(NA_real_, length(abs_est))
names(ranked) <- predictors_all
if (sum(!is.na(abs_est)) > 0) {
# rank with largest = 1
r <- rank(-abs_est, ties.method = "average")
# keep NA for missing predictors
ranked[!is.na(abs_est)] <- r[!is.na(abs_est)]
}
# ---- Build cell entries (rank with sign + significance) ----
fmt <- function(rank_val, est_val, p) {
if (is.na(rank_val)) return(NA_character_)
sign_symbol <- ifelse(est_val > 0, "+", "-")
sig_star <- ifelse(!is.na(p) && p < 0.1, "*", "")
paste0(rank_val, sign_symbol, sig_star)
}
cells <- mapply(fmt, ranked, est, pvals, USE.NAMES = FALSE)
names(cells) <- predictors_all
# AIC
aic_val <- AIC(fit)
# Return row
data.frame(
species = sp,
as.list(cells),
AIC = round(aic_val, 2),
check.names = FALSE
)
}
# Predictors in the models (must match the variable names in NETcol3 and your GLMs)
predictors_all <- c("temp", "barrier", "length", "prosper", "size", "pisc")
# Helper to get term names as they appear in the model
term_name <- function(var) paste0("scale(", var, ")")
# ---- Function to create one row per species ----
make_species_row <- function(sp, fit) {
sm <- summary(fit)
coefs <- sm$coefficients
# 1) Pull raw coefficient estimates and p-values for each predictor
est <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Estimate"] else NA_real_
})
pvals <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Pr(>|z|)"] else NA_real_
})
# 2) Rank predictors by absolute effect size
#    Larger |estimate| -> lower rank number (1 = most important)
abs_est <- abs(est)
ranked <- rep(NA_real_, length(abs_est))
names(ranked) <- predictors_all
if (sum(!is.na(abs_est)) > 0) {
# Rank only non-NA entries; ties get average rank
r <- rank(-abs_est, ties.method = "average")  # negative so largest abs gets rank 1
ranked[!is.na(abs_est)] <- r[!is.na(abs_est)]
}
# 3) Build formatted cells: "<rank><sign><* if p<0.1>"
fmt <- function(rank_val, est_val, p) {
if (is.na(rank_val)) return(NA_character_)
sign_symbol <- ifelse(est_val > 0, "+", "-")
sig_star    <- ifelse(!is.na(p) && p < 0.1, "*", "")
paste0(rank_val, sign_symbol, sig_star)
}
cells <- mapply(fmt, ranked, est, pvals, USE.NAMES = FALSE)
names(cells) <- predictors_all
# 4) AIC
aic_val <- AIC(fit)
# 5) Return one row as a data.frame
data.frame(
species = sp,
as.list(cells),
AIC = round(aic_val, 2),
check.names = FALSE
)
}
# species_vec should be the names of your models list
species_vec <- names(models)
rows <- lapply(species_vec, function(sp) make_species_row(sp, models[[sp]]))
varimp_table_ranked <- do.call(rbind, rows)
# Reorder columns: species, predictors, AIC
varimp_table_ranked <- varimp_table_ranked[, c("species", predictors_all, "AIC")]
# ---- Print to console ----
print(varimp_table_ranked)
# Predictors in the models (must match the variable names in NETcol3 and your GLMs)
predictors_all <- c("temp", "barrier", "length", "prosper", "size", "pisc")
# Helper to get term names as they appear in the model
term_name <- function(var) paste0("scale(", var, ")")
# ---- Function to create one row per species ----
make_species_row <- function(sp, fit) {
sm <- summary(fit)
coefs <- sm$coefficients
# 1) Pull raw coefficient estimates and p-values for each predictor
est <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Estimate"] else NA_real_
})
pvals <- sapply(predictors_all, function(v) {
rn <- term_name(v)
if (rn %in% rownames(coefs)) coefs[rn, "Pr(>|z|)"] else NA_real_
})
# 2) Rank predictors by absolute effect size
#    Larger |estimate| -> lower rank number (1 = most important)
abs_est <- abs(est)
ranked <- rep(NA_real_, length(abs_est))
names(ranked) <- predictors_all
if (sum(!is.na(abs_est)) > 0) {
# Rank only non-NA entries; ties get average rank
r <- rank(-abs_est, ties.method = "average")  # negative so largest abs gets rank 1
ranked[!is.na(abs_est)] <- r[!is.na(abs_est)]
}
# 3) Build formatted cells: "<rank><sign><* if p<0.1>"
fmt <- function(rank_val, est_val, p) {
if (is.na(rank_val)) return(NA_character_)
sign_symbol <- ifelse(est_val > 0, "(+)", "(-)")
sig_star    <- ifelse(!is.na(p) && p < 0.1, "*", "")
paste0(rank_val, sign_symbol, sig_star)
}
cells <- mapply(fmt, ranked, est, pvals, USE.NAMES = FALSE)
names(cells) <- predictors_all
# 4) AIC
aic_val <- AIC(fit)
# 5) Return one row as a data.frame
data.frame(
species = sp,
as.list(cells),
AIC = round(aic_val, 2),
check.names = FALSE
)
}
# ---- Build the full table for all species in your models list ----
# species_vec should be the names of your models list
species_vec <- names(models)
rows <- lapply(species_vec, function(sp) make_species_row(sp, models[[sp]]))
varimp_table_ranked <- do.call(rbind, rows)
# Reorder columns: species, predictors, AIC
varimp_table_ranked <- varimp_table_ranked[, c("species", predictors_all, "AIC")]
# ---- Print to console ----
print(varimp_table_ranked)
# ---- Write to CSV ----
write.csv(varimp_table_ranked,
"species_var_importance_COLandPERS_ranked.csv",
row.names = FALSE)
